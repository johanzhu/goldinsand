function mouseStateWalk(e){"mouseup"==e.type&&(clearInterval(walk),clap&&(clap.rotation.y=0),foot&&(foot.rotation.y=0),foot.rotation.x=0),"mousedown"==e.type&&(walk=setInterval(function(){camera.position.z-=5*Math.cos(camera.rotation.y),camera.position.x-=5*Math.sin(camera.rotation.y),clap&&(clap.rotation.y+=Math.PI/2),foot&&(foot.rotation.y-=Math.PI/2)},100))}function mouseStateLeft(e){"mouseup"==e.type&&clearInterval(left),"mousedown"==e.type&&(left=setInterval(function(){camera.rotation.y+=turnSpeed;},100))}function mouseStateRight(e){"mouseup"==e.type&&clearInterval(right),"mousedown"==e.type&&(right=setInterval(function(){camera.rotation.y-=turnSpeed;},100))}function audioAutoPlay(e){var o=document.getElementById(e);o.play(),document.addEventListener("WeixinJSBridgeReady",function(){o.play()},!1)}function onWindowResize(){WIDTH=window.innerWidth,HEIGHT=window.innerHeight,renderer.setSize(WIDTH,HEIGHT),camera.aspect=WIDTH/HEIGHT,camera.updateProjectionMatrix(),camera2.aspect=WIDTH/HEIGHT,camera2.updateProjectionMatrix()}function animate(){var e=Date.now();windForce.set(0,40,10),simulate(e),requestAnimationFrame(animate),collide(),gameOver(),render()}function render(){1==loading&&(load.style.display="none"),cScene=scene,cCamera=camera,gameover&&(cScene=scene2,cCamera=camera2);var e=clock.getDelta();particleGroupCrash.tick(e),hat&&hat.position.set(camera.position.x-20*Math.sin(camera.rotation.y),camera.position.y-5,camera.position.z-20+20*(1-Math.cos(camera.rotation.y))),hat&&hat.rotation.set(camera.rotation.x,camera.rotation.y+Math.PI/2,camera.rotation.z),head&&head.position.set(camera.position.x-20*Math.sin(camera.rotation.y),camera.position.y-5,camera.position.z-20+20*(1-Math.cos(camera.rotation.y))),head&&head.rotation.set(camera.rotation.x,camera.rotation.y+Math.PI/2,camera.rotation.z),scarf&&scarf.position.set(camera.position.x-20*Math.sin(camera.rotation.y),camera.position.y-5,camera.position.z-20+20*(1-Math.cos(camera.rotation.y))),scarf&&scarf.rotation.set(camera.rotation.x,camera.rotation.y+Math.PI/2,camera.rotation.z),clap&&clap.position.set(camera.position.x-20*Math.sin(camera.rotation.y),camera.position.y-5,camera.position.z-20+20*(1-Math.cos(camera.rotation.y))),foot&&foot.position.set(camera.position.x-20*Math.sin(camera.rotation.y),camera.position.y-5,camera.position.z-20+20*(1-Math.cos(camera.rotation.y))),particleGroupCrash.mesh.position.set(camera.position.x-1800*Math.sin(camera.rotation.y),camera.position.y-45,camera.position.z-1800+1800*(1-Math.cos(camera.rotation.y))),particleGroupCrash.mesh.rotation.set(camera.rotation.x,camera.rotation.y,camera.rotation.z),object.position.set(camera.position.x-20*Math.sin(camera.rotation.y),camera.position.y-14.5,camera.position.z-20+20*(1-Math.cos(camera.rotation.y))),object.rotation.set(camera.rotation.x,camera.rotation.y,camera.rotation.z);for(var o=cloth.particles,a=0,t=o.length;a<t;a++)clothGeometry.vertices[a].copy(o[a].position);clothGeometry.computeFaceNormals(),clothGeometry.computeVertexNormals(),clothGeometry.normalsNeedUpdate=!0,clothGeometry.verticesNeedUpdate=!0,renderer.render(cScene,cCamera)}function generateCoin(){var e=coin.clone();e.position.x=range(-2350,2360),e.position.z=range(-2360,2630),e.position.y=25,e.rotation.y=Math.PI*range(0,1),scene.add(e)}function generateCactus(){var e=cactus.clone();e.position.x=range(-2350,2360),e.position.z=range(-2360,2630),e.position.y=0,e.rotation.y=Math.PI*range(0,1),scene.add(e)}function collide(){var e=new THREE.Vector3(camera.position.x-190*Math.sin(camera.rotation.y),5,camera.position.z-190+190*(1-Math.cos(camera.rotation.y))),o=new THREE.Raycaster(e,new THREE.Vector3(1,0,0),0,65),a=new THREE.Raycaster(e,new THREE.Vector3(-1,0,0),0,65),t=new THREE.Raycaster(e,new THREE.Vector3(0,1,0),0,65);o.ray.rotation=camera.rotation,a.ray.rotation=camera.rotation,t.ray.rotation=camera.rotation;var n=o.intersectObjects(scene.children),r=o.intersectObjects(scene.children),c=o.intersectObjects(scene.children);n.length>0&&n.forEach(function(e){if("cloth"==e.object.name)return!1;eatGold(),scene.remove(e.object)}),r.length>0&&r.forEach(function(e){if("cloth"==e.object.name)return!1;eatGold(),scene.remove(e.object)}),c.length>0&&c.forEach(function(e){if("cloth"==e.object.name)return!1;eatGold(),scene.remove(e.object)})}function eatGold(){var e=document.getElementById("scorenNum"),o=parseInt(e.innerHTML);e.innerHTML=o+1,eatCoin.play()}function gameOver(){var e=document.getElementById("scorenNum"),o=parseInt(e.innerHTML),a=document.getElementById("score"),t=document.getElementById("gameover"),n=document.getElementById("walk"),r=document.getElementById("left"),c=document.getElementById("right");30==o&&(gameover=!0,camera2.position.z+=.05,e.style.opacity=0,n.style.opacity=0,r.style.opacity=0,c.style.opacity=0,a.style.opacity=0,t.style.display="block")}function degInRad(e){return e*Math.PI/180}function range(e,o){return e+(o-e)*Math.random()}var walk,left,right,walkSpeed=20,turnSpeed=Math.PI*(2/180);window.addEventListener("keydown",function(e){87==e.keyCode&&(camera.position.z-=5*Math.cos(camera.rotation.y),camera.position.x-=5*Math.sin(camera.rotation.y),clap&&(clap.rotation.y+=Math.PI/2),foot&&(foot.rotation.y-=Math.PI/2)),83==e.keyCode&&(camera.position.z+=5*Math.cos(camera.rotation.y),camera.position.x+=5*Math.sin(camera.rotation.y),clap&&(clap.rotation.y+=Math.PI/2),foot&&(foot.rotation.y-=Math.PI/2)),65==e.keyCode&&(camera.rotation.y+=turnSpeed),68==e.keyCode&&(camera.rotation.y-=turnSpeed)}),touch.on("#walk","touchstart",function(){$("#walk").css({opacity:"1"}),walk=setInterval(function(){camera.position.z-=5*Math.cos(camera.rotation.y),camera.position.x-=5*Math.sin(camera.rotation.y),clap&&(clap.rotation.y+=Math.PI/2),foot&&(foot.rotation.y-=Math.PI/2)},16.6)}),touch.on("#walk","touchend",function(){$("#walk").css({opacity:"0.6"}),clearInterval(walk),clap&&(clap.rotation.y=0),foot&&(foot.rotation.y=0),foot.rotation.x=0}),touch.on("#left","touchstart",function(){$("#left").css({opacity:"1"}),left=setInterval(function(){camera.rotation.y+=turnSpeed},100)}),touch.on("#left","touchend",function(){$("#left").css({opacity:"0.6"}),clearInterval(left)}),touch.on("#right","touchstart",function(){$("#right").css({opacity:"1"}),right=setInterval(function(){camera.rotation.y-=turnSpeed},100)}),touch.on("#right","touchend",function(){$("#right").css({opacity:"0.6"}),clearInterval(right)}),touch.on("#x","touchstart",function(){$("#tips").css({display:"none"})}),touch.on("#github","touchstart",function(){window.open("https://github.com/johanzhu/goldinsand")}),window.ontouchstart=function(e){e.preventDefault()},audioAutoPlay("bc");var world=document.createElement("div");world.setAttribute("id","world"),document.body.appendChild(world);var scene,scene2,camera,renderer,camera2,camraPos,cScene,cCamera,sand,clock=new THREE.Clock,hat,head,scarf,clap,foot,coin,clothGeometry,loading=!1,gameover=!1,load=document.getElementById("loading"),manager=new THREE.LoadingManager;manager.onLoad=function(){console.log("resourse complete!"),loading=!0,document.getElementById("tips").style.display="block"},scene=new THREE.Scene,scene2=new THREE.Scene,camera=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,.001,1e4),camera2=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,.001,1e4),camera.position.set(0,50,1800),camera2.position.set(0,50,1800),(renderer=new THREE.WebGLRenderer({alpha:!0,antialias:!0})).setSize(window.innerWidth,window.innerHeight),renderer.shadowMapEnabled=!0;var container=document.getElementById("world");container.appendChild(renderer.domElement),window.addEventListener("resize",onWindowResize,!1),window.addEventListener("load",onWindowResize.false);var axis=new THREE.AxisHelper(50),ambient=new THREE.AmbientLight(15658734);scene.add(ambient),scene2.add(ambient.clone());var directionalLight=new THREE.DirectionalLight(16777215);directionalLight.position.set(0,0,1),scene.add(directionalLight),scene2.add(directionalLight.clone());var onProgress=function(e){if(e.lengthComputable)e.loaded,e.total},mtlLoader=new THREE.MTLLoader(manager);mtlLoader.setPath("model/"),mtlLoader.load("scene.mtl",function(e){e.preload();var o=new THREE.OBJLoader(manager);o.setMaterials(e),o.setPath("model/"),o.load("scene.obj",function(e){e.name="scene",scene.add(e)},onProgress)});var textureLoader=new THREE.TextureLoader(manager),texture=textureLoader.load("./img/cloud.png"),particleGroupCrash=new SPE.Group({texture:{value:texture},blending:THREE.NormalBlending,maxParticleCount:750}),crashEmitter=new SPE.Emitter({maxAge:{value:3},position:{value:new THREE.Vector3(0,75,1600),spread:new THREE.Vector3(200,30,100)},size:{value:75,spread:50},velocity:{value:new THREE.Vector3(0,0,180)},opacity:{value:[0,1,0]},color:{value:new THREE.Color(16765032)},angle:[0,.125*Math.PI],particleCount:750});particleGroupCrash.addEmitter(crashEmitter),scene.add(particleGroupCrash.mesh);var cameraPos=camera.position.clone(),loader1=new THREE.JSONLoader(manager);loader1.load("./model/hat.json",function(e,o){model=new THREE.Mesh(e,o[0]),model.rotation.y=Math.PI/2,model.scale.set(.5,.5,.5),model.position.set(cameraPos.x,cameraPos.y-5,cameraPos.z-20),model.name="hat",hat=model,scene.add(model),scene2.add(model.clone())});var loader2=new THREE.JSONLoader(manager);loader2.load("./model/head.json",function(e,o){model=new THREE.Mesh(e,new THREE.MeshLambertMaterial({color:16777215,transparent:!0,opacity:.7})),model.rotation.y=Math.PI/2,model.scale.set(.5,.5,.5),model.position.set(cameraPos.x,cameraPos.y-5,cameraPos.z-20),model.name="head",head=model,scene.add(model),scene2.add(model.clone())});var loader3=new THREE.JSONLoader(manager);loader3.load("./model/scarf.json",function(e,o){model=new THREE.Mesh(e,o[0]),model.rotation.y=Math.PI/2,model.scale.set(.5,.5,.5),model.position.set(cameraPos.x,cameraPos.y-5,cameraPos.z-20),model.name="scarf",scarf=model,scene.add(model),scene2.add(model.clone())});var loader4=new THREE.JSONLoader(manager);loader4.load("./model/clap.json",function(e,o){model=new THREE.Mesh(e,o[0]),model.rotation.y=Math.PI/2,model.scale.set(.5,.5,.5),model.position.set(cameraPos.x,cameraPos.y-5,cameraPos.z-20),model.name="clap",clap=model,scene.add(model),scene2.add(model.clone())});var loader5=new THREE.JSONLoader(manager);loader5.load("./model/foot.json",function(e,o){model=new THREE.Mesh(e,new THREE.MeshLambertMaterial({color:6232065})),model.rotation.y=Math.PI/2,model.scale.set(.5,.5,.5),model.position.set(cameraPos.x,cameraPos.y-4.8,cameraPos.z-20),model.name="foot",foot=model,scene.add(model),scene2.add(model.clone())});var pins=[30,31,32,33,34,35],loader=new THREE.TextureLoader(manager),clothTexture=loader.load("./img/clap.png"),clothTexture2=loader.load("./img/gold.png");clothTexture.wrapS=clothTexture.wrapT=THREE.RepeatWrapping,clothTexture.anisotropy=16;var clothMaterial=new THREE.MeshPhongMaterial({specular:197379,map:clothTexture,side:THREE.DoubleSide,alphaTest:.5}),clothMaterial2=new THREE.MeshPhongMaterial({specular:197379,map:clothTexture2,side:THREE.DoubleSide,alphaTest:.5});(clothGeometry=new THREE.ParametricGeometry(clothFunction,cloth.w,cloth.h)).dynamic=!0;var uniforms={texture:{value:clothTexture}},vertexShader=document.getElementById("vertexShaderDepth").textContent,fragmentShader=document.getElementById("fragmentShaderDepth").textContent;object=new THREE.Mesh(clothGeometry,clothMaterial),object.castShadow=!0,object.scale.set(.2,.3,1),object.position.set(0,35.5,1780),object.name="cloth";var goldCape=object.clone();goldCape.material=clothMaterial2,scene.add(object),scene2.add(goldCape),object.customDepthMaterial=new THREE.ShaderMaterial({uniforms:uniforms,vertexShader:vertexShader,fragmentShader:fragmentShader,side:THREE.DoubleSide});var loader6=new THREE.JSONLoader(manager);loader6.load("./model/coin.json",function(e,o){model=new THREE.Mesh(e,new THREE.MeshLambertMaterial({color:16766720})),model.scale.set(30,30,30),model.name="coin",coin=model;for(var a=0;a<200;a++)generateCoin()}),animate(),eatCoin=document.getElementById("coin"),eatCoin.volume=1,eatCoin.addEventListener("ended",function(){eatCoin.currentTime=0}),bc=document.getElementById("bc"),bc.volume=.1;